name: WebServ CI/CD

on:
  push:
    branches: [ main, testing, bonus ]
  pull_request:
    branches: [ main, testing, bonus ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          g++ \
          make \
          python3 \
          python3-pip \
          php-cgi \
          perl \
          ruby \
          curl \
          netcat-openbsd \
          lsof \
          valgrind \
          siege
        pip3 install requests

    - name: Build WebServ (Standard)
      run: |
        make re
        echo "âœ“ Standard build completed"

    - name: Build WebServ (Bonus)
      run: |
        make fclean
        make bonus
        echo "âœ“ Bonus build completed"

    - name: Run Comprehensive Test Suite
      run: |
        chmod +x run_tests.sh
        chmod +x tests/run_all_tests.sh
        chmod +x tests/comprehensive_edge_cases.sh
        ./run_tests.sh
      continue-on-error: false

    - name: Run Valgrind Memory Check
      run: |
        echo "Starting valgrind memory leak detection..."
        timeout 120 valgrind \
          --leak-check=full \
          --show-leak-kinds=all \
          --track-origins=yes \
          --suppressions=valgrind.supp \
          --log-file=valgrind_report.txt \
          ./webserv webserv.conf &
        
        SERVER_PID=$!
        sleep 5
        
        # Run basic tests
        curl -s http://localhost:8080/ > /dev/null || true
        curl -s http://localhost:8080/cgi-bin/calculator.py?num1=5&num2=3&op=add > /dev/null || true
        
        # Stop server gracefully
        kill -INT $SERVER_PID 2>/dev/null || true
        wait $SERVER_PID 2>/dev/null || true
        
        echo "âœ“ Valgrind check completed"
      continue-on-error: true

    - name: Run Security Audit
      run: |
        if [ -f tests/security/run_all_security_tests.py ]; then
          chmod +x tests/security/run_all_security_tests.py
          python3 tests/security/run_all_security_tests.py || true
          echo "âœ“ Security audit completed"
        fi
      continue-on-error: true

    - name: Generate Test Summary
      if: always()
      run: |
        echo "## ðŸ“Š Test Results Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Check if test reports exist
        if [ -d "tests/test_output" ]; then
          LATEST_REPORT=$(ls -t tests/test_output/master_test_report_*.txt 2>/dev/null | head -1)
          if [ -f "$LATEST_REPORT" ]; then
            echo "### Master Test Report" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            tail -50 "$LATEST_REPORT" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
        fi
        
        # Valgrind results
        if [ -f "valgrind_report.txt" ]; then
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Memory Check (Valgrind)" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          grep -A 10 "LEAK SUMMARY" valgrind_report.txt >> $GITHUB_STEP_SUMMARY || echo "No leaks detected" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
        fi
        
        # Security results
        if [ -d "tests/security/results" ]; then
          LATEST_SECURITY=$(ls -t tests/security/results/security_report_*.txt 2>/dev/null | head -1)
          if [ -f "$LATEST_SECURITY" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Security Audit" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            tail -30 "$LATEST_SECURITY" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
        fi

    - name: Upload Test Reports
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-reports
        path: |
          tests/test_output/
          tests/security/results/
          valgrind_report.txt
          server_test.log
        retention-days: 30
        if-no-files-found: warn

    - name: Upload Build Artifacts
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: webserv-binary
        path: webserv
        retention-days: 7

    - name: Check Test Results
      if: always()
      run: |
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "  CI/CD WORKFLOW COMPLETED"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
        echo "Check the artifacts section for:"
        echo "  â€¢ Test reports (test-reports.zip)"
        echo "  â€¢ Server binary (webserv-binary.zip)"
        echo "  â€¢ Valgrind memory check results"
        echo "  â€¢ Security audit results"
        echo ""
        
        if [ -d "tests/test_output" ]; then
          LATEST_REPORT=$(ls -t tests/test_output/master_test_report_*.txt 2>/dev/null | head -1)
          if [ -f "$LATEST_REPORT" ]; then
            if grep -q "ALL CRITICAL TESTS PASSED" "$LATEST_REPORT"; then
              echo "âœ“ Status: ALL TESTS PASSED"
              exit 0
            else
              echo "âœ— Status: SOME TESTS FAILED"
              exit 1
            fi
          fi
        fi
        
        echo "âš  Status: Could not determine test results"
        exit 1
