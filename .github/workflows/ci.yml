name: WebServ CI/CD

on:
  push:
    branches: [ main, testing, bonus ]
  pull_request:
    branches: [ main, testing, bonus ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          g++ \
          make \
          valgrind \
          python3 \
          python3-pip \
          php-cgi \
          perl \
          ruby \
          curl \
          netcat-openbsd \
          lsof
    
    - name: Install Python dependencies
      run: |
        pip3 install requests
    
    - name: Build WebServ
      run: make
    
    - name: Run Comprehensive Test Suite
      run: |
        chmod +x tests/run_all_tests.sh
        chmod +x tests/comprehensive_edge_cases.sh
        chmod +x tests/session_cookie/run_all_tests.sh 2>/dev/null || true
        chmod +x tests/security/run_tests.sh 2>/dev/null || true
        ./run_tests.sh
    
    - name: Upload Test Reports
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-reports
        path: |
          tests/test_output/*.txt
          tests/test_output/*.log
          server_test.log
        retention-days: 30
        if-no-files-found: warn
    
    - name: Upload Server Logs
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: server-logs
        path: |
          server_test.log
          server.log
          valgrind_*.log
        retention-days: 30
        if-no-files-found: warn

  valgrind-memory-check:
    runs-on: ubuntu-latest
    needs: build-and-test
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          g++ \
          make \
          valgrind \
          python3 \
          php-cgi \
          perl \
          ruby
    
    - name: Build WebServ
      run: make
    
    - name: Run Valgrind Memory Check
      run: |
        timeout 60 make vg &
        VALGRIND_PID=$!
        sleep 5
        
        # Send some test requests
        curl -s http://localhost:8080/ > /dev/null || true
        curl -s http://localhost:8080/index.html > /dev/null || true
        curl -s http://localhost:8080/cgi-bin/calculator.py?num1=5&num2=3&op=add > /dev/null || true
        
        sleep 5
        kill $VALGRIND_PID 2>/dev/null || true
        wait $VALGRIND_PID 2>/dev/null || true
      continue-on-error: true
    
    - name: Check Valgrind Results
      run: |
        if ls valgrind_*.log 1> /dev/null 2>&1; then
          echo "Valgrind log found:"
          cat valgrind_*.log
          
          # Check for critical memory leaks
          if grep -q "definitely lost: [1-9]" valgrind_*.log; then
            echo "❌ Memory leaks detected!"
            exit 1
          fi
          
          if grep -q "Invalid " valgrind_*.log; then
            echo "⚠️  Invalid memory operations detected"
            exit 1
          fi
          
          echo "✓ No critical memory issues detected"
        else
          echo "⚠️  No valgrind log found"
        fi
      continue-on-error: true
    
    - name: Upload Valgrind Reports
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: valgrind-reports
        path: valgrind_*.log
        retention-days: 30
        if-no-files-found: warn

  security-audit:
    runs-on: ubuntu-latest
    needs: build-and-test
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          g++ \
          make \
          python3 \
          python3-pip \
          curl
    
    - name: Install Python dependencies
      run: |
        pip3 install requests
    
    - name: Build WebServ
      run: make
    
    - name: Run Security Tests
      run: |
        chmod +x tests/security/run_all_security_tests.py
        # Start server
        ./webserv webserv.conf > server.log 2>&1 &
        SERVER_PID=$!
        sleep 5
        
        # Run security tests
        python3 tests/security/run_all_security_tests.py || true
        
        # Stop server
        kill $SERVER_PID 2>/dev/null || true
    
    - name: Upload Security Reports
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: security-reports
        path: tests/security/results/*.txt
        retention-days: 30
        if-no-files-found: warn
